---
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: kube-prometheus-stack
  namespace: argocd
spec:
  project: default
  source:
    repoURL: https://prometheus-community.github.io/helm-charts
    targetRevision: 69.2.0
    chart: kube-prometheus-stack
    helm:
      skipCrds: true
  ignoreDifferences:
    - group: apiextensions.k8s.io
      kind: CustomResourceDefinition
      jsonPointers:
        - /metadata/annotations
      values: |
  grafana:
    persistence:
      enabled: true
      storageClassName: synology-nfs
      size: 10Gi
      subPath: grafana
    affinity:
      nodeAffinity:
        requiredDuringSchedulingIgnoredDuringExecution:
          nodeSelectorTerms:
            - matchExpressions:
                - key: workload-type/monitoring
                  operator: In
                  values:
                    - "true"
    service:
      type: LoadBalancer
      ports:
        - name: http
          port: 80
          targetPort: 3000
          protocol: TCP

  prometheus:
  service:
    type: LoadBalancer
    ports:
      - name: http
        port: 9090
        targetPort: 9090
        protocol: TCP
  prometheusSpec:
    storage:
      volumeClaimTemplate:
        spec:
          storageClassName: synology-nfs
          accessModes: ["ReadWriteMany"]
          resources:
            requests:
              storage: 80Gi
          volumeName: synology-nfs-pv
    volumeMounts:
      - mountPath: /prometheus
        subPath: prometheus
    retention: 30d
    affinity:
      nodeAffinity:
        requiredDuringSchedulingIgnoredDuringExecution:
          nodeSelectorTerms:
            - matchExpressions:
                - key: workload-type/monitoring
                  operator: In
                  values:
                    - "true"

  alertmanager:
    alertmanagerSpec:
      storage:
        volumeClaimTemplate:
          spec:
            storageClassName: synology-nfs
            accessModes: ["ReadWriteMany"]
            resources:
              requests:
                storage: 10Gi
            volumeName: synology-nfs-pv
      volumeMounts:
        - name: storage-volume
          mountPath: /alertmanager
          subPath: alertmanager
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
              - matchExpressions:
                  - key: workload-type/monitoring
                    operator: In
                    values:
                      - "true"

  prometheusOperator:
    admissionWebhooks:
      enabled: true
    tlsProxy:
      enabled: true
    affinity:
      nodeAffinity:
        requiredDuringSchedulingIgnoredDuringExecution:
          nodeSelectorTerms:
            - matchExpressions:
                - key: workload-type/monitoring
                  operator: In
                  values:
                    - "true"

  destination:
    server: https://kubernetes.default.svc
    namespace: monitoring

  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
